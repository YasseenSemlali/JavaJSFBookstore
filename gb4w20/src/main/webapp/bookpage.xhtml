<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!--
Java Server Faces page that displays a chosen book page by the
user and displays that book's details and be able to rate it and 
add it to the shopping cart. 

@author Jasmar Badion
-->

<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:b="http://bootsfaces.net/ui"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                template="/templates/defaultTemplate.xhtml">
    <ui:define name="head">
        <title>#{booksJpaController.findBooks(param['isbn']).title}</title> 
        <h:outputStylesheet library="css" name="bookpage.css" />
        <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"></link>-->
        <!--<ui:include src="/templates/header.xhtml"></ui:include>-->
    </ui:define>

    <ui:define name="content">
        <c:set var="book" value="#{booksJpaController.findBooks(param['isbn'])}"/>
        <c:set var="authorbooks" value="#{book.getAuthorsCollection()}"/>
        <c:set var="genrebooks" value="#{book.getGenresCollection()}"/>
        <!--BELOW WORKS
        <c:set var="ges" value="#{book.getGenresCollection()[0]}"/>
        -->
        
        <c:forEach items="#{authorbooks}" var="auth">
            <c:set var="bauthors" value="#{auth}"/>
        </c:forEach>
        <c:forEach items="#{genrebooks}" var="gen">
            <c:set var="bgenres" value="#{gen}"/>
        </c:forEach>
        
        <b:container>
            <b:jumbotron> 
                <div class="">
                    <!--<h:graphicImage library="img" name = "covers/#{book.getCover()}" height="200px"/>-->
                   
                    <!--<h:graphicImage library="img" name = "covers/1984.jpg" height="200px"/>--> 
                    <!--star ratings
                    <h:form>  
                        <h:panelGrid columns="2" cellpadding="5">  
                            <h:outputText value="Rating: " />  
                            <p:rating value="#{rating.rating}" />  
                        </h:panelGrid>  
                    </h:form>  
                    -->
                    
                </div>
                <div class="">
                    <ui:decorate template="/templates/book.xhtml">
                        <ui:param name="book" value="#{book}"></ui:param>
                        <ui:param name="showPrice" value="true"></ui:param>
                        <ui:param name="showOldPrice" value="true"></ui:param>
                    </ui:decorate>
                    <!--#{msgs.title} : #{book.getTitle()} -->
                    <br></br>
                    #{msgs.author} : 
                    <c:forEach items="#{authorbooks}" var="auth">
                        #{auth.getFirstName()} #{auth.getLastName()}
                        <br></br>
                    </c:forEach>
                    <br></br>
                    Genre:
                    <c:forEach items="#{genrebooks}" var="gen">
                        #{gen.getGenre()}
                        <br></br>
                    </c:forEach>
                    <br></br>
                    Rating: #{reviewsJpaController.getAverageRating(book.getIsbn())} stars
                    <br></br>
                    <a href="#" class="btn btn-lg btn-info">Add to cart</a>
                </div>
            </b:jumbotron> 
        </b:container>
        
        <b:container>
            <div class="">
                <h2>Summary</h2>
                <p>
                    #{book.getSynopsis()}
                </p>
            </div>
        </b:container>
        
        <b:container>
            <div class="">
                <h2>Review</h2>
                <p>
                    <c:forEach items="#{book.getReviewsCollection()}" var="review">
                        <p>
                            #{(usersJpaController.findUsers(review.getUserId().getUserId())).getFirstName()} #{(usersJpaController.findUsers(review.getUserId().getUserId())).getLastName()}
                        </p>
                        <p>
                            #{review.getReview()}
                        </p>
                        <br></br>
                        Rating: #{review.getRating()} stars
                    </c:forEach>
                </p>
            </div>
        </b:container>
        
        <b:container>
            <h2>Recommendation</h2>
        </b:container>
        <b:container>
            <b:jumbotron>
                <c:forEach items="#{authorbooks}" var="auth">
                    <h3>Other books by #{auth.getFirstName()} #{auth.getLastName()}</h3>
                </c:forEach>
                
                <!--<b:row>
                    <b:column col-md="6">
                        <b:panelGrid columns="3">
                            <c:forEach items="#{authorbooks}" var="bookauts">
                                <c:forEach items="#{bookauts.getBooksCollection()}" var="ba" begin="0" end="2">
                                    <ui:decorate template="/templates/book.xhtml">
                                        <ui:param name="book" value="#{ba}"></ui:param>
                                    </ui:decorate>
                                </c:forEach>
                            </c:forEach>
                        </b:panelGrid>
                    </b:column>
                </b:row>-->
                <b:row>
                    <b:column col-md="6">
                        <b:panelGrid columns="3">
                            <c:forEach items="#{authorsJpaController.getOtherBooksBySameAuthor(book.getIsbn(), bauthors.getAuthorId(), 3)}" var="sameauthor">
                                    <ui:decorate template="/templates/book.xhtml">
                                        <ui:param name="book" value="#{sameauthor}"></ui:param>
                                    </ui:decorate>
                            </c:forEach>
                        </b:panelGrid>
                    </b:column>
                </b:row>
            </b:jumbotron>
        </b:container>
        
        <!--<b:container>
            <b:jumbotron>
                <c:forEach items="#{genrebooks}" var="gen">
                    <h3>Other books of #{gen.getGenre()} genre</h3>
                </c:forEach>
                
                <b:row>
                    <b:column col-md="6">
                        <b:panelGrid columns="3">
                            <c:forEach items="#{genrebook}" var="bookgen">
                                <c:forEach items="#{bookgen.getBooksCollection()}" var="bg" begin="0" end="2">
                                    <ui:decorate template="/templates/book.xhtml">
                                        <ui:param name="book" value="#{bg}"></ui:param>
                                    </ui:decorate>
                                </c:forEach>
                            </c:forEach>
                        </b:panelGrid>
                    </b:column>
                </b:row>
            </b:jumbotron>
        </b:container>-->
        <b:container>
            <b:jumbotron>
                <c:forEach items="#{genrebooks}" var="gen">
                    <h3>Other books of #{gen.getGenre()} genre</h3>
                </c:forEach>
                
                <b:row>
                    <b:column col-md="6">
                        <b:panelGrid columns="3">
                            <c:forEach items="#{genresJpaController.getOtherBooksOfSameGenre(book.getIsbn(), bgenres.getGenreId(), bauthors.getAuthorId(), 3)}" var="samegenre">
                                <ui:decorate template="/templates/book.xhtml">
                                    <ui:param name="book" value="#{samegenre}"></ui:param>
                                </ui:decorate>
                            </c:forEach>
                        </b:panelGrid>
                    </b:column>
                </b:row>
            </b:jumbotron>
        </b:container>
        
        <b:container>
            <h3>Review this book: </h3>
            <b:jumbotron>
                <h:form id="addBookReview">
                    <p:outputLabel>Write your review: </p:outputLabel>
                    <br></br>
                    <p:inputTextarea value="#{bookReviewBackingBean.reviews.review}" rows="5" cols="40" maxlength="750" />
                    <p:rating value="#{bookReviewBackingBean.reviews.rating}" />
                    <b:commandButton value="#{msgs.submit}" action="#{reviewsJpaController.create(bookReviewBackingBean.getReview(book, usersJpaController.findUsers(1)))}"/> <!-- user is 1 for now -->
                </h:form>
            </b:jumbotron>
        </b:container>
    </ui:define>
    
    <ui:define name="footer">
        <ui:include src="/templates/footer.xhtml"></ui:include>
    </ui:define>
</ui:composition>

